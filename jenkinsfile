pipeline {
  agent any

  triggers {
    pollSCM('* * * * *')
  }

  options {
      // timeout(time: 1, unit: 'HOURS')
      timeout(time: 15, unit: 'MINUTES')
      buildDiscarder(logRotator(numToKeepStr: '5'))
  }

  environment {
    REPO = "https://github.com/arenaitmx/devops_junior" // this must be created in the webui
    DIR_FRONT = "devops_junior/services/client"
    DIR_BACK  = "devops_junior/services/back"
    DIR_TEST  = "devops_junior/tests"
    BRANCH    = "dev"
  }

  stages {
    stage("Checkout"){
        steps {
            dir("$JENKINS_HOME/workspace/$BUILD_TAG"){
                sh "git clone -b $BRANCH $REPO"
                sh "cd devops_junior && make"
            }
        }
    }

    stage("Build"){
        parallel {
            stage("Build Front") {
              steps {
                dir("$JENKINS_HOME/workspace/$BUILD_TAG/devops_junior"){
                    sh 'ls -l'
                    sh 'docker-compose build front'
                    echo "unit test"
                }
              }
              post {
                 success {
                    //sh 'docker-compose build front'
                    sh 'ls -l '
                    echo 'successful'
                 }
                 failure {
                    sh 'ls -l'
                    echo 'failed'
                }
              }
            } // endstage

            stage("Build Back") {
              steps {
                dir("$JENKINS_HOME/workspace/$BUILD_TAG/devops_junior"){
                    sh 'ls -l '
                    sh 'docker-compose build back'
                }
              }
            } // endstage
        }
    }

    stage("Test") {
      steps {
        dir("$JENKINS_HOME/workspace/$BUILD_TAG/$DIR_TEST"){
            // tests
            echo 'running tests'
            sh 'ls -l'
        }
      }
    } // endstage


    stage("Deploy") {
        steps {
          dir("$JENKINS_HOME/workspace/$BUILD_TAG/devops_junior"){
            // tagging
            sh 'ls -l ' // local/pwd
          }
        }
    } // endstage



 } // enstages
} // endpipeline

